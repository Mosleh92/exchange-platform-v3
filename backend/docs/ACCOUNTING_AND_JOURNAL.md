# مستندسازی حسابداری و ثبت اسناد (Journal Entry)

## مقدمه

در این سیستم، هر تراکنش مالی (واریز، برداشت، انتقال، پرداخت و ...) به صورت خودکار منجر به ثبت سند حسابداری دوبل (بدهکار/بستانکار) می‌شود. این اسناد پایه گزارش‌گیری مالی، مغایرت‌یابی و شفافیت حسابداری هستند.

---

## ساختار سند حسابداری (JournalEntry)

- **transactionId**: شناسه تراکنش مرتبط
- **tenantId**: شناسه صرافی/بانک (برای ایزولاسیون داده)
- **branchId**: شناسه شعبه (در صورت وجود)
- **type**: نوع سند (`debit` یا `credit`)
- **accountId**: شناسه حساب مرتبط
- **amount**: مبلغ
- **createdAt**: تاریخ ثبت

هر تراکنش باید دقیقاً دو سند داشته باشد:

- یک سند بدهکار (debit)
- یک سند بستانکار (credit)

مجموع بدهکار و بستانکار هر تراکنش باید برابر باشد.

---

## فرآیند ثبت سند حسابداری

1. **ایجاد تراکنش**
   - هنگام ثبت تراکنش (مثلاً واریز)، سیستم به صورت خودکار دو سند حسابداری ثبت می‌کند.
2. **ثبت اسناد**
   - سند debit: افزایش موجودی حساب مقصد
   - سند credit: کاهش موجودی حساب مبدا
3. **ایزولاسیون داده**
   - tenantId و branchId در هر سند ثبت می‌شود تا داده‌ها کاملاً جدا باشند.
4. **گزارش‌گیری**
   - گزارش‌های مالی (تراز، سود و زیان، گردش حساب و ...) بر اساس اسناد حسابداری تهیه می‌شود.
5. **مغایرت‌یابی**
   - سرویس reconciliation با مقایسه اسناد حسابداری و پرداخت‌ها، مغایرت‌ها را شناسایی و ثبت می‌کند.

---

## تست صحت ثبت اسناد

- هر تراکنش باید دقیقاً دو سند (debit/credit) داشته باشد.
- جمع بدهکار و بستانکار باید برابر باشد.
- tenantId و branchId باید با تراکنش مرتبط یکسان باشد.

---

## نکات امنیتی و عملیاتی

- هیچ کاربری نمی‌تواند اسناد tenant دیگر را مشاهده یا تغییر دهد.
- ایندکس‌گذاری روی tenantId و branchId برای سرعت و مقیاس‌پذیری انجام شده است.
- تست‌های اتوماتیک صحت ثبت اسناد و ایزولاسیون داده را تضمین می‌کنند.

---

## توسعه‌های پیشنهادی

- افزودن خروجی Excel/PDF برای گزارش اسناد حسابداری
- داشبورد مدیریتی برای مشاهده و مدیریت اسناد و مغایرت‌ها
- هشدار خودکار در صورت مغایرت یا خطا در ثبت اسناد

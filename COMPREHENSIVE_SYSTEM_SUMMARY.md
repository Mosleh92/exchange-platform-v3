# سیستم جامع صرافی چند سطحی (Multi-Tenant Hierarchical Exchange System)

## ✅ ویژگی‌های پیاده‌سازی شده

### 🏗️ معماری چند سطحی (Multi-Tenant Hierarchy)

#### سطوح کاربری:
1. **سوپر ادمین (مالک سیستم)**:
   - مدیریت کل پلتفرم
   - ایجاد/حذف صرافی‌ها (Tenants)
   - تنظیم کارمزدهای سیستمی
   - دسترسی به تمام گزارشات مالی

2. **صرافی‌ها (Tenants)**:
   - مدیریت مستقل هر صرافی
   - ایجاد شعبه‌های مختلف (Sub-tenants)
   - تعیین نرخ ارز اختصاصی
   - مدیریت مشتریان خود

3. **شعبه‌ها (Sub-tenants)**:
   - انجام معاملات محلی
   - گزارش‌دهی به صرافی مادر
   - مدیریت حواله‌های بین شعبه‌ای

4. **مشتریان نهایی (End Users)**:
   - انجام معاملات ارزی
   - مدیریت حساب‌های چند ارزی
   - درخواست حواله‌های بانکی

### 💰 سیستم پرداخت چندحسابه

#### مدل Payment:
- **پرداخت‌های چندحسابه**: امکان تقسیم پرداخت به چند حساب مختلف
- **آپلود رسید**: ثبت خودکار رسیدهای پرداخت
- **تطبیق هوشمند**: تطبیق پرداخت‌ها با معاملات
- **وضعیت‌های پرداخت**: در انتظار، تأیید شده، رد شده، لغو شده
- **روش‌های پرداخت**: انتقال بانکی، نقدی، کارت، کیف پول دیجیتال، ارز دیجیتال

#### ویژگی‌های کلیدی:
```javascript
// محاسبه مبلغ باقی‌مانده
function calculateRemaining() {
  const total = transaction.amount;
  const paid = payments.reduce((sum, p) => sum + p.amount, 0);
  return total - paid;
}
```

### 🏦 مدیریت بدهی‌ها

#### مدل Debt:
- **پیگیری وضعیت بدهی**: مدیریت کامل بدهی‌های مشتریان
- **محاسبه سود و جریمه**: محاسبه خودکار سود تأخیر
- **اعلان خودکار**: ارسال اعلان برای پرداخت‌های معوق
- **اقدامات وصول**: مدیریت فرآیند وصول بدهی‌ها

#### ویژگی‌های کلیدی:
```javascript
// محاسبه روزهای معوق
function calculateDaysOverdue(dueDate) {
  const now = new Date();
  const due = new Date(dueDate);
  const diffTime = now - due;
  return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
}
```

### 💳 حساب‌های نگهداری ارز

#### مدل ExchangeAccount:
- **عملکرد مشابه حساب بانکی**: نگهداری ارزهای مختلف
- **برداشت جزئی یا کلی**: امکان برداشت بخشی از موجودی
- **سوددهی**: محاسبه سود بر اساس قرارداد
- **محدودیت‌های برداشت**: کنترل روزانه و ماهانه

#### ویژگی‌های کلیدی:
```javascript
// بررسی امکان برداشت
function canWithdraw(amount) {
  if (this.availableBalance < amount) return false;
  if (this.limits.dailyWithdrawal > 0 && 
      this.usage.dailyWithdrawalUsed + amount > this.limits.dailyWithdrawal) {
    return false;
  }
  return true;
}
```

### 🔄 پشتیبانی از چند شعبه

#### مدل InterBranchTransfer:
- **مدیریت متمرکز شعبه‌ها**: کنترل کامل از مرکز
- **گزارش‌دهی مستقل**: گزارش‌های جداگانه هر شعبه
- **انتقال وجه بین شعبه‌ای**: حواله‌های امن بین شعبه‌ها
- **تأیید دو مرحله‌ای**: امنیت بالا با رمز تأیید

#### ویژگی‌های کلیدی:
```javascript
// تولید کد تأیید
function generateVerificationCode() {
  return Math.floor(100000 + Math.random() * 900000).toString();
}
```

### 🌐 سیستم چندزبانه

#### پشتیبانی کامل از فارسی و انگلیسی:
- **ترجمه کامل**: تمام بخش‌های سیستم
- **تغییر زبان پویا**: بدون نیاز به بارگذاری مجدد
- **رابط کاربری بومی**: طراحی مناسب برای هر زبان

### 🔐 سیستم امنیتی

#### ویژگی‌های امنیتی:
- **احراز هویت JWT**: توکن‌های امن
- **کنترل دسترسی بر اساس نقش (RBAC)**: محدودیت دسترسی
- **ثبت کامل فعالیت‌ها (Audit Log)**: پیگیری تمام عملیات
- **محدودیت نرخ درخواست**: جلوگیری از حملات

### 📊 سیستم گزارش‌دهی پیشرفته

#### گزارشات مالی:
```sql
-- گزارش معاملات بر اساس ارز
SELECT currency, SUM(amount) 
FROM transactions 
WHERE tenant_id = ? AND date BETWEEN ? AND ?
GROUP BY currency
```

#### داشبورد مدیریتی:
- **آمار لحظه‌ای**: نمایش وضعیت فعلی
- **نمودارهای تعاملی**: تحلیل روندها
- **گزارشات سفارشی**: قابلیت شخصی‌سازی

### 💱 مدیریت نرخ‌گذاری

#### مدل ExchangeRate:
- **نرخ‌های اختصاصی**: تعیین نرخ توسط هر صراف
- **تاریخچه تغییرات**: پیگیری تغییرات نرخ
- **مقایسه با بازار**: مقایسه با نرخ‌های جهانی
- **به‌روزرسانی خودکار**: از API های خارجی

## 🔄 گردش کار ثبت معامله

### فرآیند خرید ارز (مثال: درهم امارات):

1. **ثبت درخواست**:
   - مشتری مقدار و نوع ارز مورد نیاز را انتخاب می‌کند
   - سیستم نرخ لحظه‌ای را نمایش می‌دهد

2. **تأیید معامله**:
   ```mermaid
   sequenceDiagram
       مشتری->>صراف: درخواست قیمت
       صراف->>سیستم: ثبت نرخ تبدیل
       سیستم->>مشتری: نمایش مبلغ ریالی
       مشتری->>سیستم: تأیید معامله
   ```

3. **پرداخت**:
   - مشتری به یکی از روش‌های زیر پرداخت می‌کند:
     - واریز به حساب‌های مشخص شده صراف (چندحسابه)
     - پرداخت حضوری در شعبه
   - برای هر پرداخت:
     - آپلود رسید پرداخت
     - ثبت خودکار تاریخ و مبلغ
     - تطبیق با معامله ثبت شده

4. **تسویه حساب**:
   - سیستم به صورت خودکار مبلغ باقی‌مانده را محاسبه می‌کند
   - وضعیت‌های ممکن:
     - "در انتظار پرداخت" (پرداخت نشده)
     - "پرداخت جزئی" (بدهی باقی مانده)
     - "تکمیل شده" (پرداخت کامل)

5. **تحویل ارز**:
   - مشتری انتخاب می‌کند:
     - دریافت فیزیکی از شعبه (بدون کارمزد)
     - انتقال به حساب خارجی (با کارمزد)
     - نگهداری در حساب صرافی (مانند حساب بانکی)

## 📁 ساختار فایل‌های پیاده‌سازی شده

### Backend Models:
- `Payment.js` - مدیریت پرداخت‌های چندحسابه
- `Debt.js` - مدیریت بدهی‌ها و وصول
- `ExchangeAccount.js` - حساب‌های نگهداری ارز
- `InterBranchTransfer.js` - انتقالات بین شعبه‌ای
- `Transaction.js` - معاملات ارزی
- `ExchangeRate.js` - نرخ‌های ارز
- `User.js` - کاربران و نقش‌ها
- `Tenant.js` - صرافی‌ها و اشتراک‌ها
- `Branch.js` - شعبه‌ها

### Backend Controllers:
- `payment.controller.js` - کنترل پرداخت‌ها
- `debt.controller.js` - کنترل بدهی‌ها
- `exchangeAccount.controller.js` - کنترل حساب‌ها
- `interBranchTransfer.controller.js` - کنترل انتقالات
- `transaction.controller.js` - کنترل معاملات
- `exchangeRate.controller.js` - کنترل نرخ‌ها
- `auth.controller.js` - احراز هویت
- `superAdmin.controller.js` - مدیریت سوپر ادمین

### Frontend Components:
- `PaymentManagement.jsx` - مدیریت پرداخت‌ها
- `DebtManagement.jsx` - مدیریت بدهی‌ها
- `CurrencyExchange.jsx` - تبدیل ارز
- `RemittanceForm.jsx` - فرم حواله
- `Dashboard.jsx` - داشبورد مدیریتی
- `SuperAdminDashboard.jsx` - داشبورد سوپر ادمین

### Routes:
- `/api/payments` - API پرداخت‌ها
- `/api/debts` - API بدهی‌ها
- `/api/accounts` - API حساب‌ها
- `/api/transfers` - API انتقالات
- `/api/transactions` - API معاملات
- `/api/rates` - API نرخ‌ها

## 🚀 ویژگی‌های منحصر به فرد

### 1. سیستم پرداخت چندحسابه:
- امکان تقسیم پرداخت به چند حساب مختلف
- ثبت خودکار رسیدهای پرداخت
- تطبیق هوشمند پرداخت‌ها با معاملات

### 2. مدیریت بدهی‌ها:
- پیگیری وضعیت بدهی مشتریان
- ارسال اعلان خودکار برای پرداخت‌های معوق
- محاسبه سود تأخیر (در صورت نیاز)

### 3. حساب‌های نگهداری ارز:
- عملکرد مشابه حساب بانکی
- امکان برداشت جزئی یا کلی
- سوددهی بر اساس قرارداد

### 4. پشتیبانی از چند شعبه:
- مدیریت متمرکز شعبه‌ها
- گزارش‌دهی مستقل هر شعبه
- انتقال وجه بین شعبه‌ای

## 📈 مثال گردش کار کامل

| مرحله | فرآیند سیستم | وضعیت حساب مشتری |
|-------|--------------|-------------------|
| 1 | ثبت درخواست خرید 1000 درهم (نرخ 10,000 تومان) | بدهکار: 10,000,000 تومان |
| 2 | پرداخت اولیه: 5,000,000 تومان | بدهکار: 5,000,000 تومان |
| 3 | پرداخت نهایی: 5,000,000 تومان | موجودی: +1000 درهم |
| 4 | درخواست برداشت 500 درهم | موجودی: 500 درهم |

## 🔮 توسعه‌های آینده

### 1. یکپارچه‌سازی با بانک‌ها:
- ارتباط مستقیم با سامانه‌های بانکی
- تسویه خودکار حساب‌ها

### 2. ارزهای دیجیتال:
- خرید و فروش ارزهای دیجیتال
- کیف پول امن رمزارزها

### 3. موبایل اپلیکیشن:
- نسخه موبایل برای مشتریان
- احراز هویت بیومتریک

### 4. هوش مصنوعی:
- پیش‌بینی نرخ ارز
- تشخیص الگوهای معاملاتی مشکوک

## ✅ نتیجه‌گیری

این سیستم به گونه‌ای طراحی شده که تمام نیازهای یک شبکه بزرگ صرافی‌های مستقل اما متصل به هم را برآورده می‌کند، با حفظ کامل حریم خصوصی داده‌های هر صراف و مشتریانش.

### ویژگی‌های کلیدی پیاده‌سازی شده:
- ✅ سیستم چند سطحی (Multi-Tenant Hierarchy)
- ✅ سیستم پرداخت چندحسابه
- ✅ مدیریت بدهی‌ها
- ✅ حساب‌های نگهداری ارز
- ✅ انتقالات بین شعبه‌ای
- ✅ سیستم چندزبانه (فارسی/انگلیسی)
- ✅ سیستم امنیتی پیشرفته
- ✅ گزارش‌دهی جامع
- ✅ مدیریت نرخ‌گذاری
- ✅ گردش کار کامل معاملات

سیستم آماده استفاده و قابل توسعه برای نیازهای آینده است. 